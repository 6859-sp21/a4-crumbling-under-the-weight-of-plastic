<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Death by Plastic</title>
  <meta name="description" content="Death by Plastic">
  <meta name="author" content="Alejandro Camacho and Calvin Phung">

  <link rel="stylesheet" href="css/styles.css?v=1.0">

</head>

<body>
  <!-- <script src="js/scripts.js"></script> -->
  <script src="https://d3js.org/d3.v6.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  

  <style>
  .node:hover{
    stroke-width: 7px !important;
    opacity: 1 !important;
  }
  #fish {
    display: flex;
    justify-content: center;
  }
  </style>
  <h1>
      Death by Plastic
  </h1>
  <div id="fish"></div>
</body>

<script>

    // set the dimensions and margins of the graph
    var width = 800
    var height = 600
    
    // append the svg object to the body of the page
    var svg = d3.select("#fish")
      .append("svg")
        .attr("width", width)
        .attr("height", height)

    var new_data = []
    
    // Read data
    d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/11_SevCatOneNumNestedOneObsPerGroup.csv", function(data) {
    
        // Filter a bit the data -> more than 1 million inhabitants
      new_data.push(data)
    }).then( () => {
            // Color palette for continents?
        var color = d3.scaleOrdinal()
          .domain(["Asia", "Europe", "Africa", "Oceania", "Americas"])
          .range(d3.schemeSet2);
      
        // Size scale for countries
        var size = d3.scaleLinear()
          .domain([0, 1400000000])
          .range([7,55])  // circle will be between 7 and 55 px wide
        // var size = function(x) {return x/1000000}
      
        // create a tooltip
        var Tooltip = d3.select("#fish")
          .append("div")
          .style("opacity", 0)
          .attr("class", "tooltip")
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")
      
        // Three function that change the tooltip when user hover / move / leave a cell
        var mouseover = function(d) {
          Tooltip
            .style("opacity", 1)
        }
        var mousemove = function(event, key) {
          Tooltip
            .html('<u>' + key.key + '</u>' + "<br>" + key.value + " inhabitants")
            .style("left", (d3.pointer(this)[0]+20) + "px")
            .style("top", (d3.pointer(this)[1]) + "px")
        }
        var mouseleave = function(d) {
          Tooltip
            .style("opacity", 0)
        }
      
        // Initialize the circle: all located at the center of the svg area
        var node = svg.append("g")
          .selectAll("circle")
          .data(new_data)
          .enter()
          .append("circle")
            .attr("class", "node")
            .attr("r", function(d){ return size(d.value)})
            .attr("cx", width / 2)
            .attr("cy", height / 2)
            .style("fill", function(d){ return color(d.region)})
            .style("fill-opacity", 0.8)
            .attr("stroke", "black")
            .style("stroke-width", 1)
            .on("mouseover", mouseover) // What to do when hovered
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
            .call(d3.drag() // call specific function when circle is dragged
                 .on("start", dragstarted)
                 .on("drag", dragged)
                 .on("end", dragended));
      
        // Features of the forces applied to the nodes:
        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink())
            .force("center", d3.forceCenter().x(width / 2).y(height / 2)) // Attraction to the center of the svg area
            .force("charge", d3.forceManyBody().strength(1)) // Nodes are attracted one each other of value is > 0
            .force("collide", d3.forceCollide().strength(.2).radius(function(d){ return (size(d.value)+3) }).iterations(1)) // Force that avoids circle overlapping
      
        // Apply these forces to the nodes and update their positions.
        // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.
        simulation
            .nodes(new_data)
            .on("tick", function(d){
              node
                  .attr("cx", function(d){ return d.x; })
                  .attr("cy", function(d){ return d.y; })
            });
      
        // What happens when a circle is dragged?
        // Source: https://stackoverflow.com/questions/64397454/d3-drag-click-in-v6-for-grouped-objects
        function dragstarted(d) {
          if (!d.active) simulation.alphaTarget(.03).restart();
          d.dx = d.x;
          d.dy = d.y;
        }
        function dragged(event, d) {
          d3.select(this).raise().attr("cx", d.x = event.x).attr("cy", d.y = event.y);
        }
        function dragended(d) {
          if (!d.active) simulation.alphaTarget(.03);
          d.dx = null;
          d.dy = null;
        }
      })
      </script> 
</html>