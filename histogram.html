<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </head>
  <body>
    <div class="body-container">
      <h1>Crumbling Under the Weight of Plastic</h1>
      <h2>Year</h2>
      <div>
        <div><p id="value-time"></p></div>
        <div id="slider-time"></div>
      </div>
  
      <div id="chart"></div>
      <div id="lineChart"></div>

      <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img class="d-block w-100" src="img/eiffel_tower.png" alt="First slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/washington_mon.png" alt="Second slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/crane_vessel.png" alt="Third slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/shanghai_tower.png" alt="Third slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/burj_khalifa.png" alt="Second slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/giza.png" alt="Third slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/gorges_dam.png" alt="Third slide">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="img/great_wall.png" alt="Third slide">
          </div>
          <!--add more images here-->
        </div>
      </div>
    </div>
    <script>
      $('.carousel').carousel({
        interval: false,
      });

      const globalData = []
      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-drowning-in-plastic/main/datasets/global-plastics-production.csv", function(data) {
        globalData.push(data)
      });

      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-death-by-plastic/main/datasets/microplastics-in-ocean.csv").then(microplastics => {
        d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-death-by-plastic/main/datasets/macroplastics-in-ocean.csv").then(macroplastics => {  
          const minYear = 1950;
          const maxYear = 2050;
          const minWeight = 0;
          const maxWeight = Math.round(d3.max(
            microplastics.concat(macroplastics), d => parseInt(d.Value)
          )/1000000)*1000000; // round max weight to nearest million

          const entity = "Emissions growth to 2050";
          const microData = microplastics.filter(d => d.Entity === entity);
          const macroData = macroplastics.filter(d => d.Entity === entity);
          // const globalData = lineData.filter(d => d.Entity === entity);
          console.log(globalData)

          let selected = [
            microData.filter(d => d.Year === minYear.toString())[0],
            macroData.filter(d => d.Year === minYear.toString())[0],
            ];



          const height = 200;
          const width = 500;
          const margin = ({top: 10, right: 60, bottom: 40, left: 25});
          const categories = ["Microplastics", "Macroplastics"];

          colorScale = d3.scaleOrdinal(d3.schemeTableau10).domain(categories); 

          xScale = d3.scaleLinear()
            .domain([minWeight, maxWeight])
            .range([0, width]);
          xMargin = xScale.copy().range([margin.left, width - margin.right])

          yScale = d3.scaleBand()
            .domain(categories)
            .range([height, 0]);
          yMargin = yScale.copy().range([height - margin.bottom, margin.top])


          //////////////////////////////////////////////////
          /////////////// Line chart axes /////////////
          //////////////////////////////////////////////////

          // Add X axis for lien chart --> it is a date format
          let x = d3.scaleTime()
              .domain([minYear, maxYear])
              .range([ 0, width ]);
          var xLineAxis = d3.axisBottom(x).tickFormat(d3.format("d")).ticks(5);

          // Add Y axis
          let y = d3.scaleLinear()
            .domain([0, d3.max(globalData, function(d) { return +d.Value; })])
            .range([ height, 0 ]);
          var yLineAxis = d3.axisLeft(y).ticks(6);

          
          
          const container = d3.create('svg')
          .attr('width', width)
          .attr('height', height)
          .style('border', '1px dotted #999');
          
          
          // append the svg object to the body of the page
          const svg = d3.select("#lineChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform","translate(" + margin.left + "," + margin.top + ")");
          
          let xLineScale = svg.append("g");
          xLineScale.attr("transform", "translate(0," + height + ")").call(xLineAxis);

          let yLineScale = svg.append("g");
          yLineScale.call(yLineAxis);

          // Add the area
          const curve = svg.append("path")
              .datum(globalData)
              .attr("fill", "#cce5df")
              .attr("stroke", "#69b3a2")
              .attr("stroke-width", 1.5)
              .attr("d", d3.area()
                .x(function(d) { return x(d.Year) })
                .y0(y(0))
                .y1(function(d) { return y(d.Value) })
                )

          svg.selectAll("circle")
            .data(globalData)
            .join("circle")
            .attr("fill", "blue")
            .attr("stroke", "none")
            .attr("cx", function(d) { return x(d.Year) })
            .attr("cy", function(d) { return y(d.Value) })
            .attr("r", 3)   

          const update = function(val) {
            const newYear = 2050 - val
            const newIndex = 101 - (2050 - val)
            const newData = globalData.slice(0, newIndex)
            x.domain([minYear, val])
                .range([ 0, width ]);
            y.domain([0, d3.max(newData, function(d) { return +d.Value; })])
              .range([ height, 0 ]);

            xLineScale.call(xLineAxis);

            yLineScale.call(yLineAxis);

            curve
                .datum(newData)
                .attr("d", d3.area()
                .x(function(d) { return x(d.Year) })
                .y0(y(0))
                .y1(function(d) { return y(d.Value) })
                )
            
            svg.selectAll("circle")
              .data(newData)
              .join("circle")
              .attr("fill", "blue")
              .attr("stroke", "none")
              .attr("cx", function(d) { return x(d.Year) })
              .attr("cy", function(d) { return y(d.Value) })
              .attr("r", 3)

            // add SVG 'rect' elements for bars
            container.selectAll('rect')
              .data(selected)
              .join('rect')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', d => xMargin(d.Value) - xMargin(0))
                .attr('height', yMargin.bandwidth())
                .style('fill', (d,i) => colorScale(categories[i]))
                .style('stroke', 'white')
                .attr('transform', (d,i) => `translate(${margin.left}, ${yMargin(categories[i])})`);
            
            // add SVG 'text' elements for labels
            container.selectAll('text')
              .data(selected)
              .join('text')
                .attr('x', d => 5 + xMargin(d.Value))
                .attr('y', (d, i) => yMargin.bandwidth()*(1.5-i))
                .attr('dy', '1.2em')
                .attr('fill', 'black')
                .style('font-size', 'small')
                .text(d => d.Value)
            
            // add x-axis
            container.append('g')
              .attr('transform', `translate(0, ${height - margin.bottom})`)
              .call(d3.axisBottom(xMargin).ticks(5))
              .append('text')
                .attr('text-anchor', 'middle')
                .attr('fill', 'black')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('x', width/2)
                .attr('y', 35)
                .text('Weight (tonnes)');
            
            // add y-axis with rotated labels
            container.append('g')
              .attr('transform', `translate(${margin.left}, 0)`)
              .call(d3.axisLeft(yMargin))
              .selectAll("text")
                .attr("dx", "1em")
                .attr("dy", "-1em")
                .style("text-anchor", "middle")
                .attr("transform", "rotate(-90)");
          };

          update();
          
          const sliderTime = d3
            .sliderBottom()
            .min(minYear)
            .max(maxYear)
            .step(1)
            .width(900)
            .tickFormat(d3.format(""))
            .default(1950)
            .on('onchange', val => {
              d3.select('p#value-time').text(val);
              selected = [
                  microData.filter(d => d.Year === val.toString())[0],
                  macroData.filter(d => d.Year === val.toString())[0]
                ];
              update(val);
              //todo only update when different
              $('.carousel').carousel(Math.floor(val/10-195)); // rotate carousel to index correlated to nearest decade(floor)
            });

          const gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 950)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)');

          gTime.call(sliderTime);

          d3.select('p#value-time').text(sliderTime.value());

          document.getElementById("chart").appendChild(container.node());
          });   
      });
    </script>
  </body>
</html>