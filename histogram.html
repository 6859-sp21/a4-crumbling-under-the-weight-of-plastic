<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </head>
  <body>
    <div class="body-container">
      <h1>Crumbling Under the Weight of Plastic</h1>
      <!-- <h2>Year</h2> -->
      <div class="slider-container">
        <div id="slider-time"></div>
        <h4 id="value-total"></h4>
        <h5 id="value-time"></h5>
      </div>
  
      <div id="line-chart"></div>
      <div class="carousel-container">
        <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
          <div class="carousel-inner">
            <div class="carousel-item active">
              <img class="d-block w-100" src="img/eiffel_tower.png" alt="First slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/washington_mon.png" alt="Second slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/crane_vessel.png" alt="Fourth slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/shanghai_tower.png" alt="Fifth slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/burj_khalifa.png" alt="Sixth slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/giza.png" alt="Seventh slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/gorges_dam.png" alt="Eighth slide">
            </div>
            <div class="carousel-item">
              <img class="d-block w-100" src="img/great_wall.png" alt="Ninth slide">
            </div>
            <!--add more images here-->
          </div>
        </div>
      </div>
      <div id="chart"></div>
      <div>
        <br />
        <h5>Sources</h5>
        <a href="https://ourworldindata.org/plastic-pollution#how-much-plastic-does-the-world-produce">Our World in Data</a>
        <br />
        <a href="https://advances.sciencemag.org/content/3/7/e1700782">Production, use, and fate of all plastics ever made</a>
        <br />
        <a href="https://www.nature.com/articles/s41598-019-49413-5">A global mass budget for positively buoyant macroplastic debris in the ocean</a>
        <br />
        <a href="https://www.newser.com/story/259238/the-10-heaviest-objects-on-earth.html">Heaviest Object on Earth Weighs 116B Pounds</a>
        <br />
      </div>

    </div>
    <script>
      $('.carousel').carousel({
        interval: false,
      });

      //Source: https://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
      function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      const weightObjects = ['']

      const globalData = []
      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-drowning-in-plastic/main/datasets/global-plastics-production-edit.csv", function(data) {
        globalData.push(data)
      });

      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-death-by-plastic/main/datasets/microplastics-in-ocean.csv").then(microplastics => {
        d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-death-by-plastic/main/datasets/macroplastics-in-ocean.csv").then(macroplastics => {  
          const minYear = 1950; // inclusive
          const maxYear = 2015; // inclusive
          const entity = "Emissions growth to 2050";
          const microData = microplastics.filter(d => d.Entity === entity && d.Year >= minYear && d.Year <= maxYear);
          const macroData = macroplastics.filter(d => d.Entity === entity && d.Year >= minYear && d.Year <= maxYear);
          const minWeight = 0;
          const maxWeight = Math.round(d3.max(
            microData.concat(macroData), d => parseInt(d.Value)
          )/1000000)*1000000; // max weight rounded to nearest million
          // const globalData = lineData.filter(d => d.Entity === entity);

          let selected = [
            microData.filter(d => d.Year === minYear.toString())[0],
            macroData.filter(d => d.Year === minYear.toString())[0],
            ];



          const height = 300;
          const width = 500;
          const margin = ({top: 40, right: 40, bottom: 40, left: 25});
          const categories = ["Microplastics", "Macroplastics"];
          
          // Line chart
          const lineMargin =  {top: 30, right: 30, bottom: 30, left: 100}
          const lineWidth = 800 - lineMargin.left - lineMargin.right
          const lineHeight = 500 - lineMargin.top - lineMargin.bottom;


          colorScale = d3.scaleOrdinal(d3.schemeTableau10).domain(categories); 

          xScale = d3.scaleLinear()
            .domain([minWeight, maxWeight])
            .range([0, width]);
          xMargin = xScale.copy().range([margin.left, width - margin.right])

          yScale = d3.scaleBand()
            .domain(categories)
            .range([height, 0]);
          yMargin = yScale.copy().range([height - margin.bottom, margin.top])


          //////////////////////////////////////////////////
          /////////////// Line chart axes /////////////
          //////////////////////////////////////////////////

          // Add X axis for line chart --> it is a date format
          let x = d3.scaleTime()
              .domain([minYear, maxYear])
              .range([ 0, lineWidth ]);
          var xLineAxis = d3.axisBottom(x).tickFormat(d3.format("d")).ticks(5);

          // Add Y axis
          let y = d3.scaleLinear()
            .domain([0, d3.max(globalData, function(d) { return d.Value; })])
            .range([ lineHeight, 0 ]);
          var yLineAxis = d3.axisLeft(y).ticks(6);

          
          
          const container = d3.create('svg')
          .attr('width', width)
          .attr('height', height)
          
          var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
          
          // append the svg object to the body of the page
          const svg = d3.select("#line-chart")
            .append("svg")
            .attr("width", lineWidth + lineMargin.left + lineMargin.right)
            .attr("height", lineHeight + lineMargin.top + lineMargin.bottom)
            .append("g")
            .attr("transform","translate(" + lineMargin.left + "," + lineMargin.top + ")");
          
          let xLineScale = svg.append("g");
          xLineScale.attr("transform", "translate(0," + lineHeight + ")").style("font-size", "14px").call(xLineAxis);

          let yLineScale = svg.append("g");
          yLineScale.style("font-size", "14px").call(yLineAxis);

          // Add the area
          const curve = svg.append("path")
              .datum(globalData)
              .attr("fill", "none")
              .attr("stroke", "black")
              .attr("stroke-width", 1.5)
              .attr("d", d3.line()
                .x(function(d) { return x(d.Year) })
                // .y0(y(0))
                .y(function(d) { return y(d.Value) })
                )

          svg.selectAll("circle")
            .data(globalData)
            .join("circle")
            .attr("fill", "black")
            .attr("stroke", "white")
            .attr("cx", function(d) { return x(d.Year) })
            .attr("cy", function(d) { return y(d.Value) })
            .attr("r", 3)   

          let maxValue = 0;

          const update = function(val) {
            const newYear = maxYear - val
            const newIndex = globalData.length - (maxYear - val)
            const newData = globalData.slice(0, newIndex)
            maxValue = d3.max(newData, function(d) { return +d.Value; })
            x.domain([minYear, val])
                .range([ 0, lineWidth ]);
            y.domain([0, maxValue])
              .range([ lineHeight, 0 ]);

            xLineScale.call(xLineAxis);

            yLineScale.call(yLineAxis);

            curve
                .datum(newData)
                .attr("d", d3.line()
                .x(function(d) { return x(d.Year) })
                // .y(y(0))
                .y(function(d) { return y(d.Value) })
                )
            
            svg.selectAll("circle")
              .data(newData)
              .join("circle")
                .attr("fill", "black")
                .attr("stroke", "white")
                .attr("cx", function(d) { return x(d.Year) })
                .attr("cy", function(d) { return y(d.Value) })
                .attr("r", 3)
                // tooltip adapted from https://bl.ocks.org/d3noob/180287b6623496dbb5ac4b048813af52
                .on("mouseover", function(event,d) {
                  div.transition()
                    .duration(200)
                    .style("opacity", .9);
                  div.html(d.Year + "<br/>" + d.Value)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
                  })
                .on("mouseout", function(d) {
                  div.transition()
                    .duration(500)
                    .style("opacity", 0);
                  });

            // add SVG 'rect' elements for bars
            container.selectAll('rect')
              .data(selected)
              .join('rect')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', d => xMargin(d.Value) - xMargin(0))
                .attr('height', yMargin.bandwidth())
                .style('fill', (d,i) => colorScale(categories[i]))
                .style('stroke', 'white')
                .attr('transform', (d,i) => `translate(${margin.left}, ${yMargin(categories[i])})`);
            
            // add SVG 'text' elements for labels
            container.selectAll('text')
              .data(selected)
              .join('text')
                .attr('x', d => 5 + xMargin(d.Value))
                .attr('y', (d, i) => yMargin.bandwidth()*(2-i))
                .attr('dy', '-1em')
                .attr('fill', 'black')
                .style('font-size', 'small')
                .text(d => d.Value)

            container.selectAll('g').remove();

            // add title
            container.append('g')
              .append('text')
                .attr('text-anchor', 'middle')
                .attr('fill', 'black')
                .style('font-size', '18px')
                .attr('x', width/2)
                .attr('y', margin.top)
                .attr('dy', '-.5em')
                .text('Plastics on Ocean Surface');
            
            // add x-axis
            container.append('g')
              .attr('transform', `translate(0, ${height - margin.bottom})`)
              .call(d3.axisBottom(xMargin).ticks(5))
              .append('text')
                .attr('text-anchor', 'middle')
                .attr('fill', 'black')
                .attr('font-weight', 'bold')
                .attr('x', width/2)
                .attr('y', 35)
                .text('Weight (tonnes)');
            
            // add y-axis with rotated labels
            container.append('g')
              .attr('transform', `translate(${margin.left}, 0)`)
              .call(d3.axisLeft(yMargin))
              .selectAll("text")
                .attr("dx", "1em")
                .attr("dy", "-1em")
                .style("text-anchor", "middle")
                .attr("transform", "rotate(-90)");
          };

          update(1950);

          const calculateCarousel = (value) => {
            const index = Math.floor(value/10-195);
            if (value === 2015) return 7;
            else return index;
          }

          const sliderDescriptions = [
            "198 Eiffel Towers",
            "109 Washington Monuments",
            "96 Pioneering Spirit Crane Vessels",
            "83 Shanghai Towers",
            "55 Burj Khalifas",
            "39 Pyramids of Khufu",
            "33 Three Gorges Dams",
            "7 Great Walls of China"
          ]
          let sliderIndex = 0;
          
          const sliderTime = d3
            .sliderBottom()
            .min(minYear)
            .max(maxYear)
            .step(1)
            .width(900)
            .tickFormat(d3.format(""))
            .default(1950)
            .on('onchange', val => {
              const newIndex = calculateCarousel(val);
              sliderIndex = newIndex;
              d3.select('h4#value-total').text("In " + val + ", the world produced " + numberWithCommas(maxValue) + " tonnes of plastic in a single year");
              d3.select('h5#value-time').text("That's more than the mass of " + sliderDescriptions[sliderIndex]);
              selected = [
                  microData.filter(d => d.Year === val.toString())[0],
                  macroData.filter(d => d.Year === val.toString())[0]
                ];
              update(val);
              //todo only update when different
              $('.carousel').carousel(newIndex); // rotate carousel to index correlated to nearest decade(floor)
            });

          const gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 950)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)');

          gTime.call(sliderTime);
          
          // d3.select('p#value-time').text(sliderTime.value());
          d3.select('h4#value-total').text("In " + sliderTime.value() + ", the world produced " + numberWithCommas(maxValue) + " tonnes of plastic in a single year");
          d3.select('h5#value-time').text("That's more than the mass of " + sliderDescriptions[sliderIndex]);

          document.getElementById("chart").appendChild(container.node());
          });   
      });
    </script>
  </body>
</html>