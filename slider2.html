<script src="https://d3js.org/d3.v6.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>

<p id="value"></p>
<div id="slider"></div>
<div id="my_dataviz"></div>

<script>
var margin = {top: 30, right: 30, bottom: 30, left: 100},
    width = 960 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

var dataset;
// get the data


var listData = []
d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-death-by-plastic/main/datasets/microplastics-in-ocean.csv", function(data) {

  listData.push(data)
}).then(() => {
  
  dataset = listData.filter(d => d.Entity === "Emissions growth to 2050");
    // Add X axis --> it is a date format
    let x = d3.scaleTime()
        .domain([1950, 2050])
        .range([ 0, width ]);
    // var xScale = svg.append("g")
    //     .attr("transform", "translate(0," + height + ")")
    //     .call(d3.axisBottom(x).tickFormat(d3.format("d")));
    var xAxis = d3.axisBottom(x).tickFormat(d3.format("d")).ticks(5);

    
    // Add Y axis
    let y = d3.scaleLinear()
      .domain([0, d3.max(dataset, function(d) { return +d.Value; })])
      .range([ height, 0 ]);
    
      // var yScale = svg.append("g")
      // .call(d3.axisLeft(y));
    var yAxis = d3.axisLeft(y).ticks(6);

    
    let xScale = svg.append("g");
    xScale.attr("transform", "translate(0," + height + ")")
      // .transition().duration(2000)
      .call(xAxis);

    let yScale = svg.append("g");
    yScale
      // .attr("transform", "translate(0," + height + ")")
      // .transition().duration(2000)
      .call(yAxis);


    // Add the area
    var curve = svg.append("path")
      .datum(dataset)
      .attr("fill", "#cce5df")
      .attr("stroke", "#69b3a2")
      .attr("stroke-width", 1.5)
      .attr("d", d3.area()
        .x(function(d) { return x(d.Year) })
        .y0(y(0))
        .y1(function(d) { return y(d.Value) })
        )
    
    svg.selectAll("circle")
        .data(dataset)
        .join("circle")
        .attr("fill", "blue")
        .attr("stroke", "none")
        .attr("cx", function(d) { return x(d.Year) })
        .attr("cy", function(d) { return y(d.Value) })
        .attr("r", 3)

    // circles
    //     .exit()
    //     .remove()
    
  // A function that update the chart when slider is moved
  function updateChart(h) {
    let newYear = 2050 - h
    let newIndex = 101 - (2050 - h)
    var newData = dataset.slice(0, newIndex)
    x.domain([1950, h])
        .range([ 0, width ]);
    y.domain([0, d3.max(newData, function(d) { return +d.Value; })])
      .range([ height, 0 ]);
    
    // let xScale = svg.append("g");
    xScale
      // .transition().duration(2000)
      .call(xAxis);

    // let yScale = svg.append("g");
    yScale
      // .attr("transform", "translate(0," + height + ")")
      // .transition().duration(2000)
      .call(yAxis);

    // var t = svg.transition();
    // t.select("g.x.axis").call(xScale);
    // svg.append("g")
    //   .call(d3.axisLeft(y));
    // update the chart
    curve
        .datum(newData)
        .attr("d", d3.area()
        .x(function(d) { return x(d.Year) })
        .y0(y(0))
        .y1(function(d) { return y(d.Value) })
        )

        // Add the line
    // circles
    //     .data(newData)
    //     .attr("cx", function(d) { return x(d.Year) })
    //     .attr("cy", function(d) { return y(d.value) })
        
    svg.selectAll("circle")
        .data(newData)
        .join("circle")
          .attr("fill", "blue")
          .attr("stroke", "none")
          .attr("cx", function(d) { return x(d.Year) })
          .attr("cy", function(d) { return y(d.Value) })
          .attr("r", 3)
        
    // circles
    //     .exit()
    //     .remove()
  }
  var slider = d3
    .sliderHorizontal()
    .displayFormat(d3.timeFormat('%Y'))
    .tickFormat(d3.format("d"))
    .min(1950)
    .max(2050)
    .step(1)
    .width(300)
    .value(0)
    .displayValue(false)
    .on('onchange', (val) => {
      d3.select('#value').text(val);
      updateChart(val)
    });

  d3.select('#slider')
    .append('svg')
    .attr('width', 1000)
    .attr('height', 100)
    .append('g')
    .attr('transform', 'translate(80,30)')
    .call(slider);
})
</script>